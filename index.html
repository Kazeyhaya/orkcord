<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrkCord ‚Äî Comunidades e Chat</title>
  <style>
    :root{
      --orkut-pink:#e057a1;
      --orkut-blue:#4da3ff;
      --orkut-soft:#f7f2ff;
      --discord-dark:#2b2d31;
      --discord-darker:#1e1f22;
      --discord-panel:#313338;
      --text-primary:#ffffff;
      --text-secondary:#b5bac1;
      --accent:#6d9cff;
      --success:#4caf50;
      --danger:#ef5350;
      --bg:#1a1b1e;
      --shadow: 0 8px 24px rgba(0,0,0,.25);
      --radius: 14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: "Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif;
      background: radial-gradient(1400px 600px at -10% -10%, rgba(224,87,161,.16), transparent 40%),
                  radial-gradient(1200px 500px at 110% -10%, rgba(77,163,255,.14), transparent 42%),
                  linear-gradient(180deg, #181a1f, #111114 60%);
      color: var(--text-primary);
      height:100vh;
      overflow:hidden;
    }
    a{color:inherit;text-decoration:none}
    .app{
      display:grid;
      grid-template-columns: 80px 280px 1fr;
      grid-template-rows: 64px 1fr 64px;
      grid-template-areas:
        "servers header header"
        "servers channels chat"
        "servers userbar chat";
      height:100vh;
      gap:12px;
      padding:12px;
    }
    /* Logo/Header */
    .header{
      grid-area: header;
      background: linear-gradient(135deg, rgba(77,163,255,.14), rgba(224,87,161,.14));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      display:flex;align-items:center;justify-content:space-between;
      padding:0 16px 0 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .brand{display:flex;align-items:center;gap:12px;font-weight:700;letter-spacing:.4px}
    .brand-badge{width:36px;height:36px;border-radius:10px;background: conic-gradient(from 180deg, var(--orkut-pink), var(--orkut-blue));display:grid;place-items:center;color:#fff;font-weight:900;box-shadow: 0 6px 20px rgba(109,156,255,.35)}
    .brand-title{display:flex;gap:8px;align-items:baseline}
    .brand-title .ork{color:var(--orkut-pink)}
    .brand-title .cord{color:var(--orkut-blue)}
    .header-actions{display:flex;gap:8px}
    .view-tabs{display:flex;gap:8px}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);color:var(--text-secondary);padding:10px 12px;border-radius:12px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:8px}
    .pill:hover{background:rgba(255,255,255,.1);color:#fff}
    .pill.active{background:rgba(255,255,255,.16);color:#fff}
    /* Servers rail */
    .servers{grid-area: servers;background: var(--discord-darker);border:1px solid rgba(255,255,255,.06);border-radius: var(--radius);padding:10px 8px;display:flex;flex-direction:column;align-items:center;gap:10px;box-shadow: var(--shadow)}
    .server{width:52px;height:52px;border-radius:18px;display:grid;place-items:center;background:linear-gradient(135deg, rgba(224,87,161,.22), rgba(77,163,255,.22));border:1px solid rgba(255,255,255,.08);cursor:pointer;transition: .2s transform, .2s background, .2s border-radius;position:relative;overflow:hidden}
    .server:hover{transform: translateY(-2px);border-radius:16px}
    .server.active{background:linear-gradient(135deg, var(--orkut-pink), var(--orkut-blue))}
    .server .emoji{font-size:22px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.4))}
    .divider{width:24px;height:2px;background:rgba(255,255,255,.08);border-radius:1px;margin:8px 0}
    .add-btn{width:52px;height:52px;border-radius:50%;border:1px dashed rgba(255,255,255,.18);color:var(--text-secondary);display:grid;place-items:center;cursor:pointer;transition:.2s;background: transparent}
    .add-btn:hover{color:#fff;border-color:rgba(255,255,255,.4)}
    /* Channels */
    .channels{grid-area: channels;background: var(--discord-panel);border:1px solid rgba(255,255,255,.06);border-radius: var(--radius);padding:12px;display:flex;flex-direction:column;gap:10px;box-shadow: var(--shadow);min-width:240px}
    .channels.hidden{display:none}
    .community-card{background: linear-gradient(180deg, rgba(224,87,161,.14), rgba(109,156,255,.1));border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;display:flex;gap:10px;align-items:center}
    .community-avatar{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background: radial-gradient(80% 80% at 20% 20%, #fff2, transparent 60%), linear-gradient(135deg, var(--orkut-pink), var(--orkut-blue));font-weight:800}
    .community-info{display:flex;flex-direction:column;line-height:1.2}
    .community-name{font-weight:700}
    .community-sub{color:var(--text-secondary);font-size:.9rem}
    .chan-section{margin-top:6px}
    .chan-title{color:var(--text-secondary);font-size:.8rem;margin:8px 6px 6px}
    .channel{display:flex;align-items:center;gap:8px;padding:8px 10px;margin:2px 0;border-radius:10px;cursor:pointer;transition:.15s;background:transparent;color:var(--text-secondary)}
    .channel.active,.channel:hover{background:rgba(255,255,255,.06);color:#fff}
    .hash{opacity:.7}
    /* Ajustar layout quando canais est√£o ocultos */
    .app.view-feed .channels,
    .app.view-profile .channels{display:none}
    .app.view-feed{grid-template-columns: 80px 1fr}
    .app.view-profile{grid-template-columns: 80px 1fr}
    /* Chat */
    .chat{grid-area: chat;background: var(--discord-dark);border:1px solid rgba(255,255,255,.06);border-radius: var(--radius);display:grid;grid-template-rows: 56px 1fr 74px;box-shadow: var(--shadow)}
    /* Feed */
    .feed{grid-area: chat;background: var(--discord-dark);border:1px solid rgba(255,255,255,.06);border-radius: var(--radius);display:grid;grid-template-rows: 56px 1fr;box-shadow: var(--shadow)}
    .feed-top{display:flex;align-items:center;justify-content:space-between;padding:0 14px;border-bottom:1px solid rgba(255,255,255,.06);background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);border-top-left-radius: var(--radius);border-top-right-radius: var(--radius)}
    .composer-feed{display:flex;gap:10px;padding:12px;border-bottom:1px solid rgba(255,255,255,.06)}
    .composer-feed .input{min-height:44px}
    .posts{overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    .post{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;display:grid;grid-template-columns:44px 1fr;gap:10px}
    .post .meta{margin:0 0 6px 0}
    .post-actions{display:flex;gap:8px;margin-top:8px}
    .mini-btn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);color:#fff; padding:6px 10px;border-radius:10px;cursor:pointer}
    .mini-btn:hover{background:rgba(255,255,255,.1)}
    .comments{margin-top:8px;border-top:1px solid rgba(255,255,255,.06);padding-top:8px;display:flex;flex-direction:column;gap:6px}
    /* Perfil */
    .profile{grid-area: chat;background: var(--discord-dark);border:1px solid rgba(255,255,255,.06);border-radius: var(--radius);box-shadow: var(--shadow);display:grid;grid-template-rows:56px 1fr}
    .profile-top{display:flex;align-items:center;justify-content:space-between;padding:0 14px;border-bottom:1px solid rgba(255,255,255,.06);background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);border-top-left-radius: var(--radius);border-top-right-radius: var(--radius)}
    .profile-body{overflow:auto;padding:14px;display:grid;grid-template-columns:300px 1fr;gap:14px}
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
    .friends{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:8px}
    .friend{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px;text-align:center}
    .chat-top{display:flex;align-items:center;justify-content:space-between;padding:0 14px;border-bottom:1px solid rgba(255,255,255,.06);background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);border-top-left-radius: var(--radius);border-top-right-radius: var(--radius)}
    .chat-topic{display:flex;align-items:center;gap:10px}
    .topic-badge{color:#fff;background:linear-gradient(135deg, var(--orkut-pink), var(--orkut-blue));padding:6px 10px;border-radius:999px;font-weight:600}
    .chat-actions{display:flex;gap:8px}
    .icon-btn{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;cursor:pointer;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);color:#fff8;transition:.2s}
    .icon-btn:hover{color:#fff;background:rgba(255,255,255,.1)}
    .messages{padding:14px;overflow:auto;scroll-behavior:smooth;display:flex;flex-direction:column;gap:12px}
    .msg{display:grid;grid-template-columns: 44px 1fr;gap:10px;align-items:start;animation:fadeIn .3s ease}
    .avatar{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background: linear-gradient(135deg, var(--orkut-blue), var(--orkut-pink));font-weight:800}
    .bubble{background: rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 12px}
    .meta{color:var(--text-secondary);font-size:.85rem;margin-bottom:4px}
    .composer{display:flex;gap:10px;align-items:center;padding:10px;border-top:1px solid rgba(255,255,255,.06)}
    .input{flex:1;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px 12px;color:#fff;outline:none;transition:.2s}
    .input:focus{border-color: rgba(109,156,255,.6);box-shadow:0 0 0 3px rgba(109,156,255,.15)}
    .send{background: linear-gradient(135deg, var(--orkut-pink), var(--orkut-blue));border:none;border-radius:12px;color:#fff;padding:12px 14px;cursor:pointer;font-weight:700;transition:.2s;box-shadow:0 8px 16px rgba(109,156,255,.25)}
    .send:hover{transform: translateY(-1px)}
    /* User bar */
    .userbar{grid-area: userbar;background: var(--discord-panel);border:1px solid rgba(255,255,255,.06);border-radius: var(--radius);display:flex;align-items:center;justify-content:space-between;padding:0 12px;box-shadow: var(--shadow)}
    .me{display:flex;align-items:center;gap:10px}
    .me .avatar{width:36px;height:36px;border-radius:10px}
    .presence{width:10px;height:10px;border-radius:50%;background:var(--success);border:2px solid var(--discord-panel)}
    .user-actions{display:flex;gap:8px}
    /* Utilities */
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    /* Responsivo */
    @media (max-width: 1080px){
      .app{grid-template-columns:72px 1fr;grid-template-rows:64px auto 64px 1fr;grid-template-areas:
        "servers header"
        "servers channels"
        "servers userbar"
        "servers chat"}
    }
    @media (max-width: 720px){
      .app{grid-template-columns:64px 1fr;grid-template-rows:64px auto 1fr 64px;grid-template-areas:
        "servers header"
        "servers channels"
        "servers chat"
        "servers userbar"}
      .header-actions{display:none}
    }
  </style>
  <meta name="color-scheme" content="dark">
</head>
<body>
  <div class="app">
    <aside class="servers" aria-label="Comunidades">
      <div class="server active" title="Amigos ‚ù§Ô∏è"><span class="emoji">üíó</span></div>
      <div class="server" title="Tecnologia üíª"><span class="emoji">üíª</span></div>
      <div class="server" title="M√∫sica üéµ"><span class="emoji">üéµ</span></div>
      <div class="server" title="Games üéÆ"><span class="emoji">üéÆ</span></div>
      <div class="divider"></div>
      <button class="add-btn" title="Nova Comunidade">+</button>
    </aside>

    <header class="header" role="banner">
      <div class="brand" aria-label="OrkCord">
        <div class="brand-badge">OC</div>
        <div class="brand-title"><span class="ork">Ork</span><span class="cord">Cord</span></div>
      </div>
      <div class="header-actions">
        <div class="view-tabs">
          <button class="pill active" data-view="feed">Feed</button>
          <button class="pill" data-view="chat">Chat</button>
          <button class="pill" data-view="profile">Perfil</button>
        </div>
        <button class="pill" id="btn-explore">Explorar</button>
      </div>
    </header>

    <aside class="channels" aria-label="Canais">
      <div class="community-card">
        <div class="community-avatar">OK</div>
        <div class="community-info">
          <div class="community-name">Comunidade Orkut Nostalgia</div>
          <div class="community-sub">3.254 membros ‚Ä¢ since 2004</div>
        </div>
      </div>
      <div class="chan-section">
        <div class="chan-title">Canais de Texto</div>
        <div class="channel active" data-channel="geral"><span class="hash">#</span><span>geral</span></div>
        <div class="channel" data-channel="scraps"><span class="hash">#</span><span>scraps</span></div>
        <div class="channel" data-channel="testimonials"><span class="hash">#</span><span>depoimentos</span></div>
        <div class="channel" data-channel="albums"><span class="hash">#</span><span>√°lbuns</span></div>
      </div>
      <div class="chan-section">
        <div class="chan-title">Canais de Voz</div>
        <div class="channel" data-channel="voz-g1">üéôÔ∏è geral</div>
        <div class="channel" data-channel="voz-music">üé∂ m√∫sica</div>
      </div>
    </aside>

    <!-- FEED -->
    <section class="feed" id="view-feed" hidden>
      <div class="feed-top">
        <div class="chat-topic"><div class="topic-badge">OrkCord Feed</div><span class="meta">‚Äî Postagens das suas comunidades</span></div>
        <div class="chat-actions"><button class="icon-btn" id="btn-refresh">üîÑ</button></div>
      </div>
      <div class="composer-feed">
        <input class="input" id="feedInput" type="text" placeholder="Compartilhe algo..." />
        <button class="send" id="feedSend">Publicar</button>
      </div>
      <div class="posts" id="posts"></div>
    </section>

    <!-- CHAT -->
    <main class="chat" aria-live="polite" id="view-chat">
      <div class="chat-top">
        <div class="chat-topic"><div class="topic-badge" id="topic"># geral</div><span class="meta">‚Äî Bem-vinde ao OrkCord!</span></div>
        <div class="chat-actions">
          <button class="icon-btn" title="Pesquisar" id="btn-search">üîé</button>
          <button class="icon-btn" title="Fixados" id="btn-pin">üìå</button>
          <button class="icon-btn" title="Membros" id="btn-members">üë•</button>
        </div>
      </div>
      <div class="messages" id="messages" role="log">
        <!-- Mensagens iniciais -->
      </div>
      <div class="composer">
        <input class="input" id="composerInput" type="text" placeholder="Envie uma mensagem para #geral" autocomplete="off" aria-label="Mensagem">
        <button class="send" id="sendBtn">Enviar</button>
      </div>
    </main>

    <!-- PERFIL -->
    <section class="profile" id="view-profile" hidden>
      <div class="profile-top"><div class="chat-topic"><div class="topic-badge">Perfil</div><span class="meta">‚Äî Seu perfil social</span></div></div>
      <div class="profile-body">
        <div class="card">
          <div class="avatar" style="width:64px;height:64px;border-radius:16px;margin-bottom:8px">VC</div>
          <div><strong id="profileName">Voc√™</strong></div>
          <div class="meta" id="profileBio">Apaixonado por comunidades e bate-papo.</div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="mini-btn" id="editBioBtn">Editar bio</button>
          </div>
        </div>
        <div class="card">
          <h3 style="margin-bottom:8px">Depoimentos</h3>
          <div id="testimonials" class="comments"></div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <input class="input" id="testimonialInput" placeholder="Escreva um depoimento..." />
            <button class="send" id="testimonialSend">Adicionar</button>
          </div>
          <h3 style="margin:12px 0 8px">Amigos</h3>
          <div class="friends" id="friends"></div>
        </div>
      </div>
    </section>

    <footer class="userbar" role="contentinfo">
      <div class="me">
        <div class="avatar">VC</div>
        <div>
          <div><strong>Voc√™</strong> <span class="meta">@orklover</span></div>
          <div class="meta">Mood: <span style="color:var(--orkut-pink)">‚ù§ feliz</span></div>
        </div>
      </div>
      <div class="user-actions">
        <div class="presence" title="online"></div>
        <button class="icon-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
        <button class="icon-btn" title="Sair">üö™</button>
      </div>
    </footer>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Estado do canal atual e usu√°rio
    let currentChannel = "geral";
    let currentView = "feed"; // vis√£o inicial
    const storedUser = localStorage.getItem("orkcord:user");
    let currentUser = storedUser && storedUser.trim() ? storedUser.trim() : null;
    if (!currentUser) {
      currentUser = prompt("Digite seu nome de usu√°rio:");
      if (!currentUser || !currentUser.trim()) currentUser = "Voc√™";
      localStorage.setItem("orkcord:user", currentUser);
    }
    // Conex√£o com backend Socket.IO (s√≥ usado no Chat)
    const socket = io();
    socket.on('connect', () => {
      // S√≥ conecta ao canal quando entrar no Chat
      if (currentView === "chat") {
        socket.emit('joinChannel', { channel: currentChannel, user: currentUser });
        fetchHistory(currentChannel);
      }
    });
    // Recebendo mensagens remotas (s√≥ processa no Chat)
    socket.on('message', (msg) => {
      if (currentView !== "chat") return;
      if (!msg || msg.channel !== currentChannel) return;
      addMessageBubble({ u: msg.user || "Membro", h: timeFromTs(msg.ts) || nowTime(), t: msg.text });
    });
    // Indicador de digitando (s√≥ no Chat)
    const typingEl = document.createElement("div");
    typingEl.className = "meta";
    let typingTimeout = null;
    socket.on('typing', (ev) => {
      if (currentView !== "chat") return;
      if (!ev || ev.channel !== currentChannel) return;
      typingEl.textContent = ev.typing ? `${ev.user} est√° digitando...` : "";
      if (ev.typing) {
        messagesEl.appendChild(typingEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(()=> typingEl.textContent = "", 1500);
      }
    });

    // Mock de mensagens por canal (estilo Orkut + Discord)
    const channelSeed = {
      geral: [
        { u: "Ana", h: "09:12", t: "Bom dia! Quem lembra dos depoimentos do Orkut? üòÑ" },
        { u: "Bruno", h: "09:15", t: "Saudade dos scraps! Mas esse layout novo t√° lindo." },
        { u: "Voc√™", h: "09:16", t: "Bem-vindes ao OrkCord ‚ú®" },
      ],
      scraps: [
        { u: "Carol", h: "10:05", t: "Deixa um scrap fofo aqui üíå" },
      ],
      testimonials: [
        { u: "Diego", h: "08:22", t: "Pessoa incr√≠vel, 100% confi√°vel. +1" },
        { u: "Voc√™", h: "08:30", t: "Obrigada pelo depoimento! ü•π" },
      ],
      albums: [
        { u: "Voc√™", h: "11:00", t: "Subi fotos do encontro da comunidade üì∏" },
      ],
    };

    const messagesEl = document.getElementById("messages");
    const topicBadge = document.getElementById("topic");
    const inputEl = document.getElementById("composerInput");
    const sendBtn = document.getElementById("sendBtn");
    const channels = document.querySelectorAll(".channel[data-channel]");
    // Feed/Profile refs
    const postsEl = document.getElementById("posts");
    const feedInput = document.getElementById("feedInput");
    const feedSend = document.getElementById("feedSend");
    const profileNameEl = document.getElementById("profileName");
    const profileBioEl = document.getElementById("profileBio");
    const editBioBtn = document.getElementById("editBioBtn");
    const testimonialsEl = document.getElementById("testimonials");
    const testimonialInput = document.getElementById("testimonialInput");
    const testimonialSend = document.getElementById("testimonialSend");
    const friendsEl = document.getElementById("friends");

    function renderChannel(name){
      messagesEl.innerHTML = "";
      fetchHistory(name).then(()=>{
        const seed = channelSeed[name] || [];
        seed.forEach(addMessageBubble);
      });
      topicBadge.textContent = `# ${name.replace("-", " ")}`;
      inputEl.placeholder = `Envie uma mensagem para #${name}`;
      document.querySelectorAll(".channel").forEach(c => c.classList.remove("active"));
      const active = document.querySelector(`.channel[data-channel="${name}"]`);
      if (active) active.classList.add("active");
      // Trocar de sala no backend
      currentChannel = name;
      socket.emit('joinChannel', { channel: currentChannel, user: currentUser });
    }

    // FEED (via API)
    async function apiGetPosts(){
      const r = await fetch('/api/posts'); if(!r.ok) return [];
      const j = await r.json(); return j.posts || [];
    }
    async function apiCreatePost(text){
      await fetch('/api/posts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user: currentUser, text })});
    }
    async function apiLikePost(id){
      await fetch(`/api/posts/${encodeURIComponent(id)}/like`, { method:'POST' });
    }
    async function apiCommentPost(id, text){
      await fetch(`/api/posts/${encodeURIComponent(id)}/comment`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user: currentUser, text })});
    }
    async function renderPosts(){
      postsEl.innerHTML = "";
      const posts = (await apiGetPosts()).slice().reverse();
      posts.forEach(p => {
        const node = document.createElement("div");
        node.className = "post";
        node.innerHTML = `
          <div class="avatar">${(p.user||'?').slice(0,2).toUpperCase()}</div>
          <div>
            <div class="meta"><strong>${p.user||'Membro'}</strong> ‚Ä¢ ${timeFromTs(p.ts) || nowTime()}</div>
            <div>${escapeHtml(p.text)}</div>
            <div class="post-actions">
              <button class="mini-btn" data-like="${p.id}">‚ù§ ${p.likes||0}</button>
              <button class="mini-btn" data-comment="${p.id}">Comentar</button>
            </div>
            <div class="comments">${(p.comments||[]).map(c=>`<div class="meta"><strong>${c.user}</strong>: ${escapeHtml(c.text)}</div>`).join("")}</div>
          </div>`;
        postsEl.appendChild(node);
      });
    }
    feedSend?.addEventListener("click", async ()=>{
      const text = (feedInput?.value||"").trim();
      if(!text) return;
      await apiCreatePost(text); feedInput.value=""; renderPosts();
    });
    postsEl?.addEventListener("click", async (e)=>{
      const t = e.target;
      if (t.matches("[data-like]")) {
        const id = t.getAttribute("data-like");
        await apiLikePost(id); renderPosts();
      } else if (t.matches("[data-comment]")) {
        const id = t.getAttribute("data-comment");
        const text = prompt("Coment√°rio:");
        if (text && text.trim()) { await apiCommentPost(id, text.trim()); renderPosts(); }
      }
    });

    // Perfil (API)
    profileNameEl.textContent = currentUser;
    async function loadProfile(){
      const r = await fetch('/api/profile'); if(!r.ok) return;
      const p = await r.json();
      profileBioEl.textContent = p.bio || '';
    }
    async function loadTestimonialsFriends(){
      const r = await fetch('/api/testimonials'); if(!r.ok) return;
      const { testimonials = [], friends = [] } = await r.json();
      testimonialsEl.innerHTML = testimonials.map(t=>`<div class="meta"><strong>${t.user}</strong>: ${escapeHtml(t.text)}</div>`).join("");
      friendsEl.innerHTML = friends.map(n=>`<div class="friend">${escapeHtml(n)}</div>`).join("");
    }
    editBioBtn?.addEventListener("click", async ()=>{
      const v = prompt("Nova bio:", profileBioEl.textContent || ""); if(v==null) return;
      const r = await fetch('/api/profile/bio', { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bio: v })});
      if (r.ok) { const j = await r.json(); profileBioEl.textContent = j.bio; }
    });
    testimonialSend?.addEventListener("click", async ()=>{
      const v = (testimonialInput?.value||"").trim(); if(!v) return;
      const r = await fetch('/api/testimonials', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user: currentUser, text: v })});
      if (r.ok) { testimonialInput.value=""; loadTestimonialsFriends(); }
    });
    loadProfile(); loadTestimonialsFriends(); renderPosts();

    function addMessageBubble({u, h, t}){
      const item = document.createElement("div");
      item.className = "msg";
      item.innerHTML = `
        <div class="avatar">${(u||"V").slice(0,2).toUpperCase()}</div>
        <div class="bubble">
          <div class="meta"><strong>${u}</strong> ‚Ä¢ hoje √†s ${h}</div>
          <div>${escapeHtml(t)}</div>
        </div>
      `;
      messagesEl.appendChild(item);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function nowTime(){
      const d = new Date();
      return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }
    function timeFromTs(ts){
      if (!ts) return null;
      const d = new Date(ts);
      return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }
    async function fetchHistory(channel){
      try{
        const res = await fetch(`/api/history?channel=${encodeURIComponent(channel)}`);
        if(!res.ok) return;
        const data = await res.json();
        (data.messages || []).forEach(m => {
          addMessageBubble({ u: m.user || "Membro", h: timeFromTs(m.ts) || nowTime(), t: m.text });
        });
      }catch(_e){}
    }

    function sendCurrent(){
      const text = inputEl.value.trim();
      if(!text) return;
      addMessageBubble({ u: currentUser, h: nowTime(), t: text });
      // Enviar via Socket.IO
      socket.emit('sendMessage', { channel: currentChannel, text, user: currentUser });
      inputEl.value = "";
      inputEl.focus();
    }

    sendBtn.addEventListener("click", sendCurrent);
    inputEl.addEventListener("keydown", (e)=>{
      socket.emit('typing', { channel: currentChannel, user: currentUser, typing: true });
      if(e.key === "Enter") sendCurrent();
    });
    // Event listeners dos canais (s√≥ funcionam no Chat)
    channels.forEach(c => {
      c.addEventListener("click", ()=>{
        // S√≥ processa se estiver na view Chat
        if (currentView === "chat") {
          renderChannel(c.getAttribute("data-channel"));
        }
      });
    });

    // Seguran√ßa b√°sica para textos
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }

    // Troca de vis√µes (Feed/Chat/Perfil)
    const tabs = document.querySelectorAll(".view-tabs .pill");
    const appEl = document.querySelector(".app");
    const channelsEl = document.querySelector(".channels");
    const viewMap = {
      feed: document.getElementById("view-feed"),
      chat: document.getElementById("view-chat"),
      profile: document.getElementById("view-profile")
    };
    function activateView(name){
      currentView = name; // Atualizar estado
      // Remover classes de vis√£o anteriores
      appEl.classList.remove("view-feed", "view-chat", "view-profile");
      // Adicionar classe da vis√£o atual
      appEl.classList.add(`view-${name}`);
      // Mostrar/esconder se√ß√µes
      Object.entries(viewMap).forEach(([k,el])=>{
        if(!el) return;
        if (k===name){ el.hidden = false; }
        else { el.hidden = true; }
      });
      // Atualizar tabs
      tabs.forEach(b=> b.classList.toggle("active", b.dataset.view===name));
      // Ajustar layout: canais s√≥ no Chat
      if (name === "chat") {
        appEl.style.gridTemplateColumns = "80px 280px 1fr";
        channelsEl.style.display = "flex";
        // Conectar ao socket e inicializar canal quando entrar no Chat
        if (socket.connected) {
          socket.emit('joinChannel', { channel: currentChannel, user: currentUser });
          fetchHistory(currentChannel);
        }
        // Inicializar canal se n√£o houver mensagens
        if (messagesEl && messagesEl.children.length === 0) {
          renderChannel(currentChannel);
        }
      } else {
        appEl.style.gridTemplateColumns = "80px 1fr";
        channelsEl.style.display = "none";
      }
    }
    tabs.forEach(b=> b.addEventListener("click", ()=> activateView(b.dataset.view)));
    activateView("feed"); // vis√£o inicial

    // Pequenas intera√ß√µes
    document.getElementById("btn-explore").addEventListener("click", ()=>{
      // S√≥ funciona no Chat
      if (currentView === "chat") {
        addMessageBubble({u:"Sistema", h: nowTime(), t:"Em breve: explorar comunidades em destaque üí´"});
      } else {
        alert("Funcionalidade em desenvolvimento! üöÄ");
      }
    });
  </script>
</body>
</html>

